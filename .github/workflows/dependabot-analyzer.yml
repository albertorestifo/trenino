name: Dependabot PR Analyzer

on:
  pull_request:
    types: [opened]

jobs:
  analyze-dependabot:
    if: github.actor == 'dependabot[bot]'
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      contents: read
      pull-requests: write
      issues: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 1

      - name: Analyze with Claude
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            Analyze Dependabot PR #${{ github.event.pull_request.number }} and post a safety assessment comment.

            ## Instructions

            1. **Get PR details** using `gh pr view ${{ github.event.pull_request.number }} --json title,body,files`

            2. **Parse the PR title** to extract:
               - Package name
               - Old version and new version
               - Update type (major/minor/patch)
               - Ecosystem (from branch name or file paths: mix.lock = Elixir, Cargo.lock = Rust, etc.)

            3. **Search for package usage** in the codebase:
               - For Elixir packages: search for the module name in lib/ (e.g., `circuits_uart` ‚Üí search for `Circuits.UART`)
               - For Rust packages: search for `use <package>` or `<package>::` in tauri/src-tauri/
               - For GitHub Actions: search in .github/workflows/

            4. **Fetch the changelog** if available in the PR body (look for [Release notes] or [Changelog] links)

            5. **Assess risk level**:
               - üî¥ High Risk: Major version bump OR breaking changes detected in changelog
               - üü° Medium Risk: Minor version bump with new features, or widely-used package
               - üü¢ Low Risk: Patch version with only bug fixes, or dev-only dependency

            6. **Post a comment** on the PR using this format:

            ```
            ## ü§ñ Dependabot PR Analysis

            **Package:** <package> (<ecosystem>)
            **Update:** v<old> ‚Üí v<new> (<type>)
            **Risk Level:** <emoji> <level>

            ### Assessment
            <‚úÖ Safe to merge / ‚ö†Ô∏è Needs review / üö® Breaking changes detected>

            ### Changelog Summary
            - <key changes from changelog, or "No changelog available">

            ### Impact on Codebase
            - Found <N> usage locations in <paths>
            - <analysis of whether any breaking changes affect the usage>

            ### Recommendations
            - [ ] <specific action items if any>

            ---
            ü§ñ Generated by Claude Code
            ```

            Use `gh pr comment ${{ github.event.pull_request.number }} --body "..."` to post the comment.
            Use a heredoc for the comment body to handle special characters properly.

      - name: Post fallback comment on failure
        if: failure()
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh pr comment ${{ github.event.pull_request.number }} --body "## ‚ö†Ô∏è Dependabot PR Analysis - Failed

          Automated analysis could not be completed. Please review this update manually.

          [View workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

          ---
          ü§ñ Dependabot PR Analyzer"
